## :pencil: Table of Contents

- [Part 1. í”„ë¡œì íŠ¸ ì†Œê°œ](#1-í”„ë¡œì íŠ¸-ì†Œê°œ)
- [Part 2. ì‚¬ìš© ê¸°ìˆ  ìŠ¤íƒ](#2-ì‚¬ìš©-ê¸°ìˆ -ìŠ¤íƒ)
- [Part 3. ì•„í‚¤í…ì²˜](#3-ì•„í‚¤í…ì²˜)
- [Part 4. ì¶”ê°€ ê¸°ëŠ¥](#4-ì¶”ê°€-ê¸°ëŠ¥)
- [Part 5. ì´ìŠˆ ì •ë¦¬](#5-ì´ìŠˆ-ì •ë¦¬)  
- [Part 6. ë³´ì™„í•  ì ](#6-ë³´ì™„í• -ì )

<br><br>

# 1. í”„ë¡œì íŠ¸ ì†Œê°œ
**The Rank of Korea (2022)\_version2**

"**ë‚´ê°€ ì¡°ì„  ì‹œëŒ€ë¡œ ëŒì•„ê°€ ì •ì¹˜ë¥¼ í•œë‹¤ë©´?**"ì„ ì£¼ì œë¡œ í•œ **ì–¸ë¡ í˜• ì»¤ë®¤ë‹ˆí‹°í”Œë«í¼**ì…ë‹ˆë‹¤. í”„ë¡œì íŠ¸ì˜ ëª©ì ì€ ì´ì „ì— ê°œë°œí–ˆë˜ [The Rank of Korea (2021)_version1](https://github.com/s2lee/rok_version1) ì˜ ì½”ë“œë¥¼ ë¦¬íŒ©í† ë§í•˜ê³  ìƒˆë¡œìš´ ê¸°ìˆ  ìŠ¤íƒì„ ìµíˆê³ ì í•¨ì…ë‹ˆë‹¤.

â—ï¸ **The Rank of Korea (2022)_version2** -> **https://therok.net**

ğŸ›  **ëª©í‘œ ê¸°ìˆ  ìŠ¤íƒ ë° í•™ìŠµ ë°©í–¥**
1. Django(DRF)-React-Nginx-Gunicorn-PostgreSQL-AWS
2. DB - PostgreSQL, Redis
3. Index, Cache ì‚¬ìš©
4. Celery(Redis)
5. Docker
6. Version Control System(Git)
7. Test Code ì‘ì„±
8. Code Refactoring(OOP, DRY)
9. Linux í™˜ê²½ ì ì‘
10. Vim ì‚¬ìš©

<br><br>

# 2. ì‚¬ìš© ê¸°ìˆ  ìŠ¤íƒ
### Frontend
<p>
    <img src="https://img.shields.io/badge/Javascript-F7DF1E?style=flat-square&logo=Javascript&logoColor=white"/>
    <img src="https://img.shields.io/badge/React-61DAFB?style=flat-square&logo=React&logoColor=white"/>
</p>

### Backend
<p>
    <img src="https://img.shields.io/badge/Docker-2496ED?style=flat-square&logo=Docker&logoColor=white"/>
    <img src="https://img.shields.io/badge/Python-3776AB?style=flat-square&logo=Python&logoColor=white"/>
    <img src="https://img.shields.io/badge/Django-092E20?style=flat-square&logo=Django&logoColor=white"/>
    <img src="https://img.shields.io/badge/Celery-37814A?style=flat-square&logo=Celery&logoColor=white"/>
    <img src="https://img.shields.io/badge/NGINX-009639?style=flat-square&logo=NGINX&logoColor=white"/><br>
    <img src="https://img.shields.io/badge/Gunicorn-499848?style=flat-square&logo=Gunicorn&logoColor=white"/>
    <img src="https://img.shields.io/badge/PostgreSQL-4169E1?style=flat-square&logo=PostgreSQL&logoColor=white"/>
    <img src="https://img.shields.io/badge/Redis-DC382D?style=flat-square&logo=Redis&logoColor=white"/>
    <img src="https://img.shields.io/badge/Amazon AWS-232F3E?style=flat-square&logo=Amazon AWS&logoColor=white"/>
</p>

### Tools
<p>
    <img src="https://img.shields.io/badge/Pycharm-000000?style=flat-square&logo=Pycharm&logoColor=white"/>
    <img src="https://img.shields.io/badge/Visual Studio-5C2D91?style=flat-square&logo=Visual Studio&logoColor=white"/>
    <img src="https://img.shields.io/badge/Git-F05032?style=flat-square&logo=Git&logoColor=white"/>
</p>

### Version
<p>
    <img src="https://img.shields.io/badge/python-v3.9.6-blue">
    <img src="https://img.shields.io/badge/django-v3.2.6-092E20">
    <img src="https://img.shields.io/badge/celery-5.2.3-37814A">
    <img src="https://img.shields.io/badge/ec2%3Aubuntu-v22.04-blue">
</p>

**etc.**
- Code Style Guides - flake8, isort, black
- SSL - Let's Encrypt(Certbot)

<br><br>
# 3. ì•„í‚¤í…ì²˜
<img src="https://user-images.githubusercontent.com/82914197/169293309-7e1e9368-1fad-4516-8879-55f76e92b01a.jpg">

<br><br>

# 4. ì¶”ê°€ ê¸°ëŠ¥

### ë§¤ì¼ ìì • ì¸ê¸°ê°€ ì¢‹ì€ ê¸°ì‚¬ 3ê°œë¥¼ ì˜¤ëŠ˜ì˜ ì‹ ë¬¸ìœ¼ë¡œ ì„ ì •í•˜ê³  ê¸°ì‚¬ë¥¼ ì‘ì„±í•œ ì‚¬ëŒì—ê²Œ í¬ì¸íŠ¸ë¥¼ ë¶€ì—¬í•˜ëŠ” ê¸°ëŠ¥:sparkles: 

**1. DRYë¥¼ ìœ„í•´ Django Managerì—ì„œ Custom QuerySetì„ ì‚¬ìš©**
```python
class ArticleVoteManager(models.Manager):
    def get_queryset(self):
        return (
            super()
            .get_queryset()
            .annotate(
                total_votes=Count("spear", distinct=True)
                - Count("shield", distinct=True)
            )
            .order_by("-total_votes")
        )

class Article(models.Model):
    ...

    objects_sorted_by_vote = ArticleVoteManager()
```

**2. Celeryë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì—… ì£¼ê¸° ì„¤ì • ë° ì‘ì—… ìˆ˜í–‰**
```python
CELERY_BEAT_SCHEDULE = {
    'choose_article_every_midnight': {
        'task': 'news.tasks.choose_article_every_midnight',
        'schedule': crontab(minute=0, hour=0),
    },
}

...

@shared_task
def choose_article_every_midnight():
    try:
        categories = Category.objects.all()
        for category in categories:
            articles = Article.objects_sorted_by_vote.filter(
                category=category, date_posted__date=date.today()
            )[:3]
            for article in articles:
                article.is_news = True
                article.save()
                user = User.objects.get(username=article.author)
                user.point += 50
                user.save()
    except ValueError as e:
        print(e)
    else:
        return "success"
```

### ë‚ ì§œë³„ ì‹ ë¬¸ ê²€ìƒ‰ê¸°ëŠ¥ :newspaper:
í”„ë¡ íŠ¸ë‹¨ì—ì„œ ì°¾ê³ ì í•˜ëŠ” ì‹ ë¬¸ì˜ ë‚ ì§œë¥¼ ê²€ìƒ‰í•˜ë©´ í•´ë‹¹ APIë¥¼ í˜¸ì¶œí•˜ëŠ”ë° ì´ APIëŠ” ì½ê¸° ì‘ì—…ë§Œ ìˆê¸° ë•Œë¬¸ì— DBì˜ ì ‘ê·¼ì„ ìµœì†Œí™”í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„ Query ìºì‹œ ì‚¬ìš©. ê²°ê³¼ì ìœ¼ë¡œ í•´ë‹¹ ì‹ ë¬¸ì„ DBì—ì„œ ê°€ì ¸ì˜¤ëŠ”ê²ƒì´ ì•„ë‹ˆë¼ Redisì—ì„œ ê°€ì ¸ì™€ì„œ Clientì— ë¹ ë¥´ê²Œ ì„œë¹™
```python
class SearchNewsByDate(GenericAPIView):
    permission_classes = (AllowAny,)
    serializer_class = SearchNewsByDateSerializer

    def get(self, request, *args, **kwargs):
        return self.get_response()

    def get_news_date(self):
        year = self.kwargs.get("year")
        month = self.kwargs.get("month")
        day = self.kwargs.get("day")
        return datetime.strptime(f"{year}-{month}-{day}", "%Y-%m-%d")

    def get_queryset(self):
        news_date = self.get_news_date()
        articles = Article.objects_sorted_by_vote.select_related("category").filter(
            date_posted__date=news_date, is_news=True
        )
        return articles

    def divide_articles_by_category(self):
        articles = self.get_queryset()
        categories = Category.objects.all()
        divided_articles = {}
        for category in categories:
            articles_by_category = articles.filter(category__name=category)[:3]
            serializer = self.get_serializer(articles_by_category, many=True)
            divided_articles[f"{category}"] = serializer.data
        return divided_articles

    def get_newspaper(self):
        newspaper = cache.get(f"newspaper_{self.get_news_date()}")
        if not newspaper:
            newspaper = self.divide_articles_by_category()
            cache.set(f"newspaper_{self.get_news_date()}", newspaper, 3600)
        return newspaper

    def get_response(self):
        newspaper = self.get_newspaper()
        response = Response(newspaper, status=status.HTTP_200_OK)
        if not any(newspaper.values()):
            response.data = {"detail": f"{self.get_news_date()}ì˜ ê¸°ì‚¬ëŠ” ì—†ìŠµë‹ˆë‹¤."}
        return response
```

<br><br>

# 5. ì´ìŠˆ ì •ë¦¬
- docker celery RecursionError:Â maximumÂ recursionÂ depthÂ exceededÂ whileÂ callingÂ aÂ PythonÂ object ë¬¸ì œ â€”> celery ì´ë¯¸ì§€ë¥¼ backend ê²ƒì„ ê°€ì ¸ë‹¤ ì“°ëŠ”ë° .env.dev íŒŒì¼ì„ ì§€ì •í•´ì£¼ì§€ ì•Šì•„ì„œ
- media í´ë”ê°€ ìƒì„±ë˜ëŠ” ìœ„ì¹˜ ë¬¸ì œ -> BASE_DIR = Path(__file__).resolve().parent.parent.parentë¡œ í•´ê²°
- Reactì—ì„œ reply ë¥¼ ì–´ë–»ê²Œ ì…ë ¥í•  ìˆ˜ ìˆì„ê¹Œ? â€”> ì¬ê·€ êµ¬ì¡°ë¡œ comment form ì¬ì‚¬ìš©
- docker Pillow error â€”> Dockerfileì— && pip install Pillow && apk add libffi-dev ì…ë ¥
- aws-rok docker certbot error â€”> ALLOWED_HOSTS = os.environ.get("DJANGO_ALLOWED_HOSTS").split(" ") ì¸ë° DJANGO_ALLOWED_HOSTSë¥¼ ì½¤ë§ˆ êµ¬ë¶„ìœ¼ë¡œ ì…ë ¥í•´ì„œ
- Up/Down button api í™•ì¥ì„± â€”> getattr(article, choice)ë¥¼ ì‚¬ìš©í•´ì„œ choiceì— ë§ê²Œ í•¨ìˆ˜ ìˆ˜í–‰
- get_total_point()=self.spear.count - self.shield.count ê°€ ì—¬ëŸ¬ë²ˆ ì‚¬ìš©ë˜ë‹ˆê¹ serializersì— ë‘ì§€ë§ê³  modelsì— ë‘ê³  manager ë§Œë“¤ì–´ì„œ í•œë²ˆë§Œ ì •ì˜
- ec2 docker build ë¬¸ì œ sh: react-scripts: not found â€”> node modules ì›ì¸
- nginx - react ì—°ê²°ì‹œ í° í™”ë©´ë§Œ ë‚˜ì˜¤ëŠ” ë¬¸ì œ â€”> nginxì—ì„œ frontend staic ê²½ë¡œë¥¼ ì˜ëª» ì§€ì •í•´ì„œ 

<br><br>

# 6. ë³´ì™„í•  ì 
- count(spear - shield) ì†ë„?
- ë¡œê·¸ì¸ í›„ í™œë™ì´ ì—†ìœ¼ë©´ 1ì‹œê°„ ë’¤ì— ìë™ ë¡œê·¸ì•„ì›ƒí•˜ëŠ” ê¸°ëŠ¥
- celery task test code ì‘ì„±
- Elasticsearch
- react ì‹œê°„í‘œì‹œ timesinceë¡œ í•´ì„œ ëª‡ ë¶„ ì „ êµ¬í˜„
- comment ë³´ë‚¼ ë•Œ parent ìˆëŠ” comment ëŠ” replyë¡œ ë’¤ì— ë¶™ì´ê¸°ë§Œ í•´ì•¼í•˜ëŠ”ë°.. -> comments.filter(comment => comment.reply.parent === comment.id)í•´ì„œ commentë¥¼ ë‹¤ì‹œ useStateí•´ì£¼ë©´ ë˜ëŠ”ë° comment.reply ê°€ ì¬ê·€ë¡œ ë“¤ì–´ê°€ ìˆì–´ì„œ parent ê°’ì´ ì•ˆë¶ˆëŸ¬ì™€ì§ --> êµ¬ì¡° ë°”ê¾¸ê¸°
- S3 ì‚¬ìš© í•´ë³´ê¸°
- API ë¬¸ì„œí™”
- nginx.conf ë‹¤ì‹œ ì •ì˜?
- version1ì˜ ë ˆë²¨ë§, ì•„ì´í…œ êµ¬ë§¤ê¸°ëŠ¥ ì¶”ê°€
